<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quay B·ªëc ThƒÉm T·∫•t Ni√™n</title>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: radial-gradient(circle at top, #7f1d1d, #450a0a);
      color: #fff7ed;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .container {
      width: 100%;
      max-width: 1200px;
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    @media (max-width: 768px) {
      .container { grid-template-columns: 1fr; }
    }

    .panel {
      background: rgba(255,255,255,0.08);
      border-radius: 22px;
      padding: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.45);
      border: 2px solid rgba(250,204,21,0.3);
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
      font-size: clamp(22px, 4vw, 32px);
      color: #fde047;
    }

    textarea, select {
      width: 100%;
      border-radius: 12px;
      border: none;
      padding: 10px;
      font-size: 14px;
      margin-top: 6px;
    }

    button {
      width: 100%;
      margin-top: 14px;
      padding: 14px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 16px;
      border: none;
      cursor: pointer;
      background: linear-gradient(135deg, #fde047, #f59e0b);
      color: #7c2d12;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .wheel-wrapper {
      position: relative;
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      aspect-ratio: 1 / 1;
    }

    canvas {
      width: 100%;
      height: 100%;
    }

    .pointer {
      position: absolute;
      top: -5px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 25px solid #fde047;
      z-index: 10;
    }

    .result {
      text-align: center;
      margin-top: 16px;
      font-size: clamp(20px, 4vw, 28px);
      font-weight: 800;
      color: #fde047;
    }

    .history {
      margin-top: 12px;
      font-size: 14px;
      max-height: 120px;
      overflow-y: auto;
      background: rgba(0,0,0,0.2);
      padding: 10px;
      border-radius: 12px;
    }
    #fwCanvas {
      position: fixed;
      top: 100%;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 9999;
    }

  </style>
</head>

<body>
<div class="container" id="app">

  <div class="panel">
    <h1>üéâ ƒêi·ªÅu khi·ªÉn (MC)</h1>

    <label>Danh s√°ch ng∆∞·ªùi tham gia</label>
    <textarea id="names" rows="8" readonly></textarea>

    <label>Ch·ªçn gi·∫£i th∆∞·ªüng</label>
    <select id="prize">
      <option value="Gi·∫£i NƒÉm">üéÄ Gi·∫£i NƒÉm</option>
      <option value="Gi·∫£i T∆∞">üéÅ Gi·∫£i T∆∞</option>
      <option value="Gi·∫£i Ba">ü•â Gi·∫£i Ba</option>
      <option value="Gi·∫£i Nh√¨">ü•à Gi·∫£i Nh√¨</option>
      <option value="Gi·∫£i Nh·∫•t">ü•á Gi·∫£i Nh·∫•t</option>
      <option value="Gi·∫£i ƒê·∫∑c Bi·ªát">üèÜ Gi·∫£i ƒê·∫∑c Bi·ªát</option>
    </select>

    <button id="spinBtn">üé° QUAY</button>

    <div class="history" id="history"></div>
  </div>

  <div class="panel">
    <h1>V√≤ng quay may m·∫Øn</h1>
    <div class="wheel-wrapper">
      <div class="pointer"></div>
      <canvas id="wheel"></canvas>
    </div>
    <div class="result" id="result">‚Äî</div>    
  </div>

</div>

<audio id="spinSound">
  <source src="https://nhacchuong123.com/nhac-chuong/abcdef/Nhac-Chuong-xo-so-mien-bac.mp3" type="audio/mpeg">
</audio>

<audio id="spinSoundSpec">
  <source src="https://nhacchuong123.com/nhac-chuong/nhac-remix/ketquaxosodjremix.mp3" type="audio/mpeg">
</audio>

<canvas id="fireworks" style="position:fixed;inset:0;pointer-events:none;display:none;"></canvas>

<script>
const canvas = document.getElementById('wheel');
const ctx = canvas.getContext('2d');
const spinBtn = document.getElementById('spinBtn');
const namesInput = document.getElementById('names');
const resultEl = document.getElementById('result');
const historyEl = document.getElementById('history');
const prizeEl = document.getElementById('prize');
const spinSound = document.getElementById('spinSound');
const spinSoundSpec = document.getElementById('spinSoundSpec');
const fwCanvas = document.getElementById('fireworks');
const fwCtx = fwCanvas.getContext('2d');

namesInput.value = 
// `01
// 02
// Nguy·ªÖn Th·ªã Thanh
// 04
// 05
// 06
// 07
// 08
// 09
// 10
// 11
// 12
// Nguy·ªÖn Th·ªã Giang
// 14
// 15
// Ho√†ng Thanh T√∫
// 17
// 18
// 19
// 20
// 21
// 22
// 23
// 24
// 25`;
`B√πi B√≠ch Li√™n
B√πi Th·∫ø S√°ng
ƒê√†m Th·ªã Thu Th·ªßy
ƒê√†m Tr·ªçng T√πng
ƒê·∫∑ng VƒÉn Gi√°p
ƒê·∫∑ng VƒÉn Ho√†n
ƒê·ªó C√¥ng S∆°n
D∆∞∆°ng VƒÉn ƒê√¥
Gi√°p VƒÉn Nghi·ªáp
Ho√†ng L√™ L∆∞∆°ng
Ho√†ng Thanh T√∫
Ho√†ng Th·ªã Thanh V√¢n
Ho√†ng VƒÉn Hi·∫øn
Ho√†ng VƒÉn Quang
Ho√†ng VƒÉn Vi·ªát
Ki·ªÅu Phi H√πng
L√£ Th·ªã Ph∆∞∆°ng Thanh
L√£ Tu·∫•n Anh
L√™ H·ªìng Phong
L√™ S·ªπ Tin
L√™ Thu Huy·ªÅn
L√™ VƒÉn C∆∞·ªùng
L√™ Xu√¢n C·∫ßn
L√™ Xu√¢n Ph√∫c
L∆∞u VƒÉn Xu√¢n
Ng√¥ Tr∆∞∆°ng T·∫°o
Nguy·ªÖn ƒêƒÉng Th√¨n
Nguy·ªÖn Duy Anh
Nguy·ªÖn Duy ƒê√†n
Nguy·ªÖn H·ªìng Hi·∫øu
Nguy·ªÖn H·ªØu Di·ªán
Nguy·ªÖn H·ªØu Do√£n
Nguy·ªÖn H·ªØu Ho·∫±ng
Nguy·ªÖn H·ªØu To·∫£n
Nguy·ªÖn Kh·∫Øc To·∫£n
Nguy·ªÖn Ki√™n C∆∞·ªùng
Nguy·ªÖn M·∫°nh Hu√¢n
Nguy·ªÖn Minh ƒê·ªìng
Nguy·ªÖn Quang Huy
Nguy·ªÖn Quang Th·ªãnh
Nguy·ªÖn Thanh Nam
Nguy·ªÖn Th·ªã Giang
Nguy·ªÖn Th·ªã H√†
Nguy·ªÖn Th·ªã H·ªìng Anh
Nguy·ªÖn Th·ªã Ng·ªçc Lan
Nguy·ªÖn Th·ªã Nguy·ªát H√†
Nguy·ªÖn Th·ªã Ph∆∞·ª£ng
Nguy·ªÖn Th·ªã Thanh
Nguy·ªÖn Th·ªã Thu H·∫±ng
Nguy·ªÖn Th·ªã Th√∫y H·∫±ng
Nguy·ªÖn Th·ªã Y·∫øn
Nguy·ªÖn Thu H·∫±ng
Nguy·ªÖn Thu V√¢n
Nguy·ªÖn Ti·∫øn T∆∞·ªüng
Nguy·ªÖn Trung S∆°n
Nguy·ªÖn Tu·∫•n Anh
Nguy·ªÖn Tu·∫•n ƒê√†n
Nguy·ªÖn VƒÉn Chinh
Nguy·ªÖn VƒÉn ƒê·ª©c
Nguy·ªÖn VƒÉn Hi·∫øu
Nguy·ªÖn VƒÉn H√≤a
Nguy·ªÖn VƒÉn H·ª£p
Nguy·ªÖn VƒÉn Minh
Nguy·ªÖn VƒÉn Quang
Nguy·ªÖn VƒÉn ThƒÉng
Nguy·ªÖn Vi·ªát B·∫Øc
Ph·∫°m H·ªìng Thanh
Ph·∫°m Th·ªã H√†
Phan Minh L·ªÖ
T·∫° Trung Ki√™n
Tr·∫ßn C√¥ng B·∫Øc
Tr·∫ßn ƒê·ª©c Long
Tr·∫ßn Huy V√µ
Tr·∫ßn Quang Hi·ªáu
Tr·∫ßn Quang H∆∞ng
Tr·∫ßn Trung D≈©ng
Tri·ªáu VƒÉn Th·∫Øng
Tr·ªãnh Ng·ªçc Ph∆∞∆°ng Anh
V≈© ƒê√¨nh Khang
V≈© Xu√¢n Gi√°p`;

let names = [];
let winners = [];
let angle = 0;
let spinning = false;
let hasData = false; // c√≥ d·ªØ li·ªáu quay ch∆∞a

// ===== C·∫§U H√åNH S·ªê L∆Ø·ª¢NG GI·∫¢I =====
const PRIZE_LIMITS = {
  'Gi·∫£i ƒê·∫∑c Bi·ªát': 1,
  'Gi·∫£i Nh·∫•t': 2,
  'Gi·∫£i Nh√¨': 2,
  'Gi·∫£i Ba': 3,
  'Gi·∫£i T∆∞': 3,
  'Gi·∫£i NƒÉm': 5
};

const RESERVED_NAMES = [
  'Nguy·ªÖn Th·ªã Giang',
  'Nguy·ªÖn Th·ªã Thanh',
  'Ho√†ng Thanh T√∫'
];

const prizeCount = {};
Object.keys(PRIZE_LIMITS).forEach(p => prizeCount[p] = 0);


function resizeCanvas() {
  const size = canvas.parentElement.clientWidth;
  canvas.width = size * 2;
  canvas.height = size * 2;
  ctx.setTransform(2, 0, 0, 2, 0, 0);
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function drawWheel() {
  const size = canvas.width / 2;
  const radius = size / 2 - 10;
  const cx = size / 2;
  const cy = size / 2;
  const COLOR_PALETTE = [
    '#ef4444', // ƒë·ªè
    '#3b82f6', // xanh d∆∞∆°ng
    '#22c55e', // xanh l√°
    '#f59e0b', // cam
    '#a855f7', // t√≠m
    '#06b6d4', // cyan
    '#e11d48', // h·ªìng ƒë·∫≠m
    '#84cc16', // lime
    '#f97316', // cam ƒë·∫≠m
    '#0ea5e9', // sky
    '#8b5cf6', // violet
    '#14b8a6', // teal
    ];
  

  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!names.length) return;

  const slice = (2 * Math.PI) / names.length;

  names.forEach((name, i) => {
    const start = angle + i * slice;
    const end = start + slice;

    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, radius, start, end);
    // ctx.fillStyle = `hsl(${i * 360 / names.length}, 90%, 55%)`;
    ctx.fillStyle = COLOR_PALETTE[i % COLOR_PALETTE.length];
    ctx.fill();

    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(start + slice / 2);
    ctx.textAlign = 'right';
    ctx.fillStyle = '#451a03';
    ctx.font = 'bold 12px sans-serif';
    ctx.fillText(name, radius - 10, 5);
    ctx.restore();
  });
}

function getRandomTargetAvoiding(names, avoidNames, startAngle) {
  const slice = (2 * Math.PI) / names.length;

  while (true) {
    const randIndex = Math.floor(Math.random() * names.length);
    const name = names[randIndex];

    if (avoidNames.includes(name)){
      console.log('spin again...');
      continue;
    } 

    const sliceCenter = randIndex * slice + slice / 2;
    const spins = 10;

    return (
      angle +
      spins * 2 * Math.PI +
      (2 * Math.PI - (startAngle % (2 * Math.PI)) - sliceCenter - Math.PI / 2)
    );
  }
}


function spin() {
  if (spinning) return;
  let prize = prizeEl.value;

  if (prizeCount[prize] >= PRIZE_LIMITS[prize]) {
    alert(`‚ùå ${prize} ƒë√£ quay ƒë·ªß ${PRIZE_LIMITS[prize]} ng∆∞·ªùi r·ªìi!`);
    return;
  }

  names = namesInput.value
    .split('\n')
    .map(n => n.trim())
    .filter(n => n && !winners.includes(n));
  
   // drawWheel();

  if (!names.length) {
    alert('Kh√¥ng c√≤n ng∆∞·ªùi ƒë·ªÉ quay');
    return;
  }

  spinning = true;
  spinBtn.disabled = true;
  resultEl.textContent = 'ƒêang quay...';
  document.querySelector('#app > div:nth-child(1)').style.display = 'none';
  if (prize === "Gi·∫£i ƒê·∫∑c Bi·ªát") {
    spinSound.pause();
    spinSoundSpec.currentTime = 0;
    spinSoundSpec.play();
  }
  else {
    spinSoundSpec.pause();
    spinSound.currentTime = 0;
    spinSound.play();
  }

  let spinTime = 0;
  if (prize === "Gi·∫£i ƒê·∫∑c Bi·ªát") {
     spinTime = 12000 + Math.random() * 2000; // 10‚Äì12 gi√¢y
  }
  else 
  {
    spinTime = 4000 + Math.random() * 2000;
  }
  const start = performance.now();
  angle = 0;
  const startAngle = angle;
  // const startAngle = angle % (2 * Math.PI);

  //const target = startAngle + Math.PI * 10 + Math.random() * Math.PI * 2;

  // ===== CH·ªà ƒê·ªäNH NG∆Ø·ªúI TR√öNG =====
  const forcedNameSpec = 'Nguy·ªÖn Th·ªã Giang'; // ho·∫∑c null n·∫øu quay random
  const forcedName1 = 'Ho√†ng Thanh T√∫'; // ho·∫∑c null n·∫øu quay random
  const forcedName2 = 'Nguy·ªÖn Th·ªã Thanh'; // ho·∫∑c null n·∫øu quay random
  let target=0;
  let targetSpec=0;
  let target1=0;
  let target2=0;

  try {
    if (forcedNameSpec && names.includes(forcedNameSpec)) {
      const index = names.indexOf(forcedNameSpec);
      const slice = (2 * Math.PI) / names.length;
      const sliceCenter = index * slice + slice / 2;
      const spins = 10;

      targetSpec = startAngle +  spins * 2 * Math.PI +  (2 * Math.PI - sliceCenter - Math.PI / 2);
    }

    if (forcedName1 && names.includes(forcedName1)) {
      const index = names.indexOf(forcedName1);
      const slice = (2 * Math.PI) / names.length;
      const sliceCenter = index * slice + slice / 2;
      const spins = 10;

      target1 = startAngle +  spins * 2 * Math.PI +  (2 * Math.PI - sliceCenter - Math.PI / 2);
    }

    if (forcedName2 && names.includes(forcedName2)) {
      const index = names.indexOf(forcedName2);
      const slice = (2 * Math.PI) / names.length;
      const sliceCenter = index * slice + slice / 2;
      const spins = 10;

      target2 = startAngle +  spins * 2 * Math.PI +  (2 * Math.PI - sliceCenter - Math.PI / 2);
    }
    let next = true;
    if (prize === "Gi·∫£i Nh√¨" && prizeCount["Gi·∫£i Nh√¨"] === 1) {
        target = target2;
    }
    else if (prize === "Gi·∫£i Nh·∫•t" && prizeCount["Gi·∫£i Nh·∫•t"] === 0) {
      target = target1;
    }
    else if (prize === "Gi·∫£i ƒê·∫∑c Bi·ªát" && prizeCount["Gi·∫£i ƒê·∫∑c Bi·ªát"] === 0) {
      target = targetSpec;
    }
    else 
    //if  (prize === "Gi·∫£i NƒÉm" || prize === "Gi·∫£i T∆∞" || prize === "Gi·∫£i Ba" || (prize === "Gi·∫£i Nh√¨" && prizeCount["Gi·∫£i Nh√¨"] === 0))
    {
      // quay random b√¨nh th∆∞·ªùng
      // target =  startAngle +  Math.PI * 10 +  Math.random() * Math.PI * 2;   
      target = getRandomTargetAvoiding(names,RESERVED_NAMES.filter(n => !winners.includes(n)),startAngle);
    }
    
  } catch (error) {
    console.log(error);
  }

  


  function animate(now) {
    
    const progress = Math.min((now - start) / spinTime, 1);
    const ease = 1 - Math.pow(1 - progress, 3);
    angle = startAngle + (target - startAngle) * ease;
    drawWheel();
    if (progress < 1){
      requestAnimationFrame(animate);
    }
    else {
      finish();
    }
  }
  requestAnimationFrame(animate);
}

/* ================= FIX CHU·∫®N M≈®I T√äN ================= */
function finish() {
  const slice = (2 * Math.PI) / names.length;

  // B√ô G√ìC M≈®I T√äN (12 GI·ªú = -PI/2)
  const correctedAngle =  (2 * Math.PI - ((angle + Math.PI / 2) % (2 * Math.PI))) % (2 * Math.PI);

  const index = Math.floor(correctedAngle / slice);
  //const winnerIndex = Math.floor(Math.random() * names.length);
  const winner = names[index];

  const prize = prizeEl.value;
    prizeCount[prize]++;

    // N·∫øu quay ƒë·ªß ‚Üí kh√≥a gi·∫£i n√†y
    if (prizeCount[prize] >= PRIZE_LIMITS[prize]) {
    const option = [...prizeEl.options].find(o => o.value === prize);
    if (option) option.disabled = true;
    }
  
  winners.push(winner);
  hasData = true; // ƒë√£ c√≥ d·ªØ li·ªáu quay
  resultEl.innerHTML = `<span style="font-size: 30px;">üéÅ ${prize}: </span> </br> <span style="font-size: 45px;">${winner}</span>`;
  historyEl.innerHTML += `<div>${prize} ‚Äì <b>${winner}</b></div>`;

  launchTextFireworks(winner);
        // Gi·ªØ ch·ªØ 2 gi√¢y r·ªìi m·ªõi n·ªï
  setTimeout(() => {
      document.querySelector('#app > div:nth-child(1)').style.display = 'block';
  }, 6000);

  spinning = false;
  spinBtn.disabled = false;
}

spinBtn.addEventListener('click', spin);
drawWheel();

window.addEventListener('beforeunload', function (e) {
  if (!hasData) return;

  e.preventDefault();
  e.returnValue = 'N·∫øu reload trang, to√†n b·ªô k·∫øt qu·∫£ quay th∆∞·ªüng s·∫Ω b·ªã m·∫•t. B·∫°n c√≥ ch·∫Øc kh√¥ng?';
});

  function launchTextFireworks(text) {
  fwCanvas.style.display = 'block';
  //fwCanvas.style.left = '-200px'; // d·ªãch sang tr√°i 100px
  //fwCanvas.style.top = '-200px'; // d·ªãch sang tr√°i 100px

  // ===== FIX 1: SCALE CANVAS CHO N√âT =====
  const dpr = window.devicePixelRatio || 1;
  const rect = fwCanvas.getBoundingClientRect();

  fwCanvas.width = rect.width * dpr;
  fwCanvas.height = rect.height * dpr;

  fwCanvas.style.width = window.innerWidth + 'px';
  fwCanvas.style.height = window.innerHeight + 'px';

  fwCtx.setTransform(dpr, 0, 0, dpr, 0, 0);

  fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);

  // ===== FIX 2: V·∫º CH·ªÆ TO + VI·ªÄN =====
  const centerX = window.innerWidth / 2;
  const centerY = window.innerHeight / 2;
  fwCtx.font = 'bold 55px Arial';
  fwCtx.textAlign = 'center';      // ‚ùó s·ª≠a l·ªói rihgt ‚Üí center
  fwCtx.textBaseline = 'middle';

  // vi·ªÅn ch·ªØ
  fwCtx.lineWidth = 4;
  fwCtx.strokeStyle = '#000';
  fwCtx.strokeText(text, centerX, centerY);

  // ru·ªôt ch·ªØ
  fwCtx.fillStyle = '#fff';
  fwCtx.fillText(text, centerX, centerY);

  const colors = ['#fde047', '#facc15', '#fb7185', '#38bdf8'];

  // gi·ªØ ch·ªØ 2 gi√¢y r·ªìi n·ªï
  setTimeout(() => {
    explodeText();
  }, 500);

  // ===== 3. H√ÄM N·ªî CH·ªÆ =====
  function explodeText() {
    const img = fwCtx.getImageData(0, 0, fwCanvas.width, fwCanvas.height);
    const particles = [];

    for (let y = 0; y < img.height; y += 3) {
      for (let x = 0; x < img.width; x += 3) {
        const i = (y * img.width + x) * 4 + 3;
        if (img.data[i] > 0) {
          particles.push({
            x,
            y,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10,
            life: 350,
            alpha: 1,
            color: colors[Math.floor(Math.random() * colors.length)]
          });
        }
      }
    }

    animate(particles);
  }

  // ===== 4. ANIMATE PH√ÅO HOA =====
  function animate(particles) {
    fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);

    particles.forEach(p => {
      if (p.life <= 0) return;

      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.015;
      p.life--;
      p.alpha = p.life / 200;

      fwCtx.globalAlpha = p.alpha;
      fwCtx.fillStyle = p.color;
      fwCtx.fillRect(p.x, p.y, 2, 2); // üëà nh·ªè l·∫°i cho n√©t
    });

    fwCtx.globalAlpha = 1;

    if (particles.some(p => p.life > 0)) {
      requestAnimationFrame(() => animate(particles));
    } else {
      fwCanvas.style.display = 'none';
    }
  }
}


</script>
<script>
    document.addEventListener('contextmenu', e => e.preventDefault());

    document.addEventListener('keydown', function (e) {
      // Ctrl+U
      if (e.ctrlKey && (e.key === 'u' || e.key === 'U')) {
        e.preventDefault();
      }

      // Ctrl+U
      if (e.ctrlKey && (e.key === 'r' || e.key === 'R')) {
        e.preventDefault();
      }

      // Ctrl+Shift+I
      if (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i')) {
        e.preventDefault();
      }

      // Ctrl+Shift+C
      if (e.ctrlKey && e.shiftKey && (e.key === 'C' || e.key === 'c')) {
        e.preventDefault();
      }

      // F12
      if (e.key === 'F12') {
        e.preventDefault();
      }
    });
</script>
<script>

  const BASE = '/raffle';
  const fakePath = '/event/2026/round/ef322c79-0092-4ef2-8490-8505d9e58465?member=80&gdb=1&gn1=2&gn2=2&gb=3&g4=3&g5=5';

  window.addEventListener('load', () => {
    if (window.location.pathname !== BASE + fakePath) {
      history.pushState({}, '', BASE + fakePath);
    }
  });

</script>

</body>
</html>
